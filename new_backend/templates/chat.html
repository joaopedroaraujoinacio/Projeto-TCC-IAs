<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAROL CHAT</title>
    <link rel="icon" href="/static/images/fi.png" type="image/png">
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: Arial, sans-serif; 
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: #0a0f1f; 
        color: #f1f1f1; 
        overflow: hidden;
    }

    h1 {
        text-align: center;
        color: #ffffff; 
        padding: 15px 0 10px;
        font-size: 1.8em; 
        border-bottom: 1px solid #1a1f35;
    }

    .tabs-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 10px 0 15px;
        border-bottom: 1px solid #1a1f35;
    }

    .tab-btn {
        padding: 8px 24px;
        background: #2a2f45;
        color: #7a7f95;
        border: 2px solid #2a2f45;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s ease;
    }

    .tab-btn:hover { background: #353a52; color: #a0a5b8; }
    .tab-btn.active { background: #ffde21; color: #000; border-color: #ffde21; box-shadow: 0 2px 8px rgba(255,222,33,0.3); }

    #messages { 
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message { 
        display: flex;
        gap: 12px;
        max-width: 60%;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user { align-self: flex-end; flex-direction: row-reverse; margin-left: auto; margin-right: 20%; }
    .message.assistant, .message.streaming { align-self: flex-start; margin-left: 20%; margin-right: auto; }

    .message::before {
        content: attr(data-avatar);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        flex-shrink: 0;
    }

    .user::before { background: #ffde21; color: #000; }
    .assistant::before, .streaming::before { background: #3b3f58; color: #ffde21; content: "AI"; }

    .message > div {
        background: #11192d;
        padding: 12px 16px;
        border-radius: 16px;
        word-wrap: break-word;
        overflow-wrap: break-word; 
        max-width: 100%; 
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .user > div { 
        background: #ffde21; 
        color: #000; 
        word-break: break-word; 
    }
    .streaming > div { border-left: 3px solid #ffde21; }

    .token-stats {
        font-size: 11px;
        color: #999;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #2a2f45;
        font-family: 'Courier New', monospace;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    form { 
        padding: 20px;
        border-top: 1px solid #1a1f35;
        display: flex;
        gap: 10px;
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
        align-items: flex-end;
    }
    
    textarea { 
        flex: 1; 
        padding: 12px 16px; 
        border-radius: 16px; 
        border: 2px solid #2a2f45; 
        background: #11192d;
        color: #f1f1f1;
        font-size: 14px;
        font-family: Arial, sans-serif;
        resize: none;
        max-height: 150px;
        min-height: 44px;
        overflow-y: hidden;
        transition: all 0.3s ease;
    }

    textarea:focus {
        outline: none;
        border-color: #ffde21;
        box-shadow: 0 2px 12px rgba(255,222,33,0.3);
        background: #1a1f35;
    }

    textarea::placeholder { color: #7a7f95; }
    
    button { 
        padding: 12px 20px; 
        background: #ffde21; 
        color: #000; 
        border: none; 
        border-radius: 12px; 
        cursor: pointer; 
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(255,222,33,0.3);
        flex-shrink: 0;
        height: 44px;
    }

    button:hover { 
        background: #ffe94d; 
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255,222,33,0.4);
    }

    button:active { transform: translateY(0); }
    button:disabled { background: #666; cursor: not-allowed; transform: none; box-shadow: none; }
    button.icon { width: auto; padding: 12px 20px; font-size: 14px; }
    button.danger { background: #ff4444; }
    button.danger:hover { background: #ff6666; }

    #uploadBox { 
        display: none; 
        position: fixed; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        background: #11192d; 
        padding: 30px; 
        border: 1px solid #444; 
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        z-index: 1000;
    }

    #uploadBox h3 { margin-bottom: 20px; color: #ffde21; }
    #uploadBox input[type="file"] { margin: 20px 0; color: #f1f1f1; }

    #helpBtn, #clearChatBtn {
        position: fixed;
        top: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ffde21;
        color: #000;
        font-weight: 700;
        font-size: 20px;
        box-shadow: 0 3px 12px rgba(255,222,33,0.4);
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #helpBtn { right: 20px; }
    #clearChatBtn {
        position: fixed;
        top: 20px;
        right: 70px;
        padding: 10px 20px;
        height: 40px;
        width: auto;
        border-radius: 20px;
        background: #ff0000;
        color: #fff;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 3px 12px rgba(255, 0, 0, 0.4);
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #clearChatBtn:hover { background: #ff6666; }

    #closeHelp {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ffde21;
        color: #000;
        font-weight: 700;
        font-size: 20px;
        box-shadow: 0 3px 12px rgba(255,222,33,0.4);
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #helpBox {
        display: none;
        position: fixed;
        top: 82px;
        right: 20px;
        background: #11192d;
        color: #fff;
        border: 1px solid #444;
        border-radius: 16px;
        padding: 20px;
        width: 220px;
        z-index: 20;
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }

    #helpBox h2 { color: #ffde21; margin-bottom: 15px; }
    #helpBox ul { text-align: left; margin: 15px 0; padding-left: 15px; }
    #helpBox li { margin-bottom: 8px; }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0a0f1f; }
    ::-webkit-scrollbar-thumb { background: #2a2f45; border-radius: 4px; }
    </style>
</head>
<body>
    <button id="clearChatBtn">Limpar conversa</button>
    <button id="helpBtn">?</button>
 
    <h1>
        <img src="/static/images/farol.png" alt="FAROL Logo" style="width:120px;">
    </h1>

    <div class="tabs-container">
        <button class="tab-btn active" id="normalChatTab">Chat Normal</button>
        <button class="tab-btn" id="ragChatTab">RAG Chat</button>
    </div>

    <div id="messages"></div>

    <form id="chatForm">
        <textarea id="messageInput" placeholder="Escreva sua mensagem..." rows="1"></textarea>
        <button type="submit" id="sendBtn">Enviar</button>
        <button type="button" id="openUpload" class="icon">Anexar</button>
    </form>

    <div id="uploadBox">
        <h3>Enviar Arquivo</h3>
        <form id="uploadForm">
            <input type="file" id="fileInput" required>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button type="submit">Enviar</button>
                <button type="button" id="cancelUpload" style="background: #666;">Cancelar</button>
            </div>
        </form>
    </div>

    <div id="helpBox">
        <h2>SOBRE</h2>
        <p>O chat FAROL permite conversar com uma IA capaz de responder perguntas e analisar contextos.</p>
        <p>Construído para operar de forma totalmente local, o sistema garante a privacidade e a autonomia no processamento de informações.</p>
        <ul>
            <li>Use o <strong>Chat Normal</strong> para perguntas gerais.</li>
            <li>Envie um anexo e use o <strong>RAG Chat</strong> para consultar documentos enviados.</li>
        </ul>
        <p>Dê o próximo passo: Experimente fazer uma consulta ou utilize o botão "Anexar" para enviar um documento e testar o poder da pesquisa contextual (RAG) em seu ambiente local!</p>
        <button id="closeHelp">X</button>
    </div>

<script>
const form = document.getElementById('chatForm');
const input = document.getElementById('messageInput');
const messagesDiv = document.getElementById('messages');
const sendBtn = document.getElementById('sendBtn');
const normalChatTab = document.getElementById('normalChatTab');
const ragChatTab = document.getElementById('ragChatTab');
let isRagMode = false;

// Conversation history - stores all messages
let conversationHistory = [];

input.addEventListener('input', function() {
    this.style.height = 'auto';
    const newHeight = Math.min(this.scrollHeight, 150);
    this.style.height = newHeight + 'px';
    this.style.overflowY = newHeight >= 150 ? 'auto' : 'hidden';
});

// Enter to send
input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
    }
});

normalChatTab.addEventListener('click', () => {
    isRagMode = false;
    normalChatTab.classList.add('active');
    ragChatTab.classList.remove('active');
});

ragChatTab.addEventListener('click', () => {
    isRagMode = true;
    ragChatTab.classList.add('active');
    normalChatTab.classList.remove('active');
});

// Clear chat button
document.getElementById('clearChatBtn').addEventListener('click', () => {
    if (confirm('Deseja realmente limpar toda a conversa?')) {
        conversationHistory = [];
        messagesDiv.innerHTML = '';
    }
});

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.setAttribute('data-avatar', 'U');
    userMsg.innerHTML = `<div>${escapeHtml(message)}</div>`;
    messagesDiv.appendChild(userMsg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    input.value = '';
    input.style.height = 'auto';
    input.style.overflowY = 'hidden';

    sendBtn.disabled = true;
    sendBtn.textContent = 'Enviando...';

    try {
        await handleStreamingChat(message);
    } catch (err) {
        console.error('Erro ao enviar mensagem:', err);
        const errorMsg = document.createElement('div');
        errorMsg.className = 'message assistant';
        errorMsg.innerHTML = `<div>Erro ao processar mensagem: ${err.message}</div>`;
        messagesDiv.appendChild(errorMsg);
        
        // Still add to history even on error so context is preserved
        conversationHistory.push({
            role: 'user',
            content: message
        });
        conversationHistory.push({
            role: 'assistant',
            content: 'Error: ' + err.message
        });
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Enviar';
    }
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function handleStreamingChat(message) {
    // Add user message to history BEFORE sending
    conversationHistory.push({
        role: 'user',
        content: message
    });

    const aiMsg = document.createElement('div');
    aiMsg.className = 'message streaming';
    
    aiMsg.innerHTML = `<div><span class="streaming-content"></span><div class="token-stats streaming-stats"></div></div>`;
    messagesDiv.appendChild(aiMsg);

    const contentSpan = aiMsg.querySelector('.streaming-content');
    const statsSpan = aiMsg.querySelector('.streaming-stats');

    let fullResponse = '';
    let tokenCount = 0;
    let startTime = Date.now();
    let firstTokenTime = null;

    const endpoint = isRagMode ? '/api/chat/rag' : '/api/chat';

    // Prepare request body - send ALL conversation history
    const requestBody = {
        message,
        history: conversationHistory.slice(0, -1) // All messages except the current user message
    };

    console.log('Sending request:', { 
        endpoint, 
        messageCount: conversationHistory.length,
        historyCount: requestBody.history.length,
        history: requestBody.history 
    });

    try {
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let currentEvent = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            
            // Process complete SSE messages (separated by double newlines)
            const messages = buffer.split('\n\n');
            buffer = messages.pop() || ''; // Keep incomplete message in buffer

            for (const message of messages) {
                if (!message.trim()) continue;
                
                const lines = message.split('\n');
                let eventType = 'message';
                let data = '';

                // Parse SSE format
                for (const line of lines) {
                    if (line.startsWith('event:')) {
                        eventType = line.slice(6).trim();
                    } else if (line.startsWith('data:')) {
                        // Don't trim the data - preserve spaces!
                        const dataContent = line.slice(5);
                        // Only remove the leading space if it exists (SSE spec adds one space after colon)
                        data += dataContent.startsWith(' ') ? dataContent.slice(1) : dataContent;
                    }
                }

                console.log('SSE Event:', eventType, 'Data:', JSON.stringify(data)); // Debug log

                // Handle different event types
                if (eventType === 'message' && data) {
                    if (!firstTokenTime) firstTokenTime = Date.now();
                    
                    tokenCount++;
                    fullResponse += data;
                    
                    contentSpan.textContent = fullResponse;
                    
                    const elapsed = (Date.now() - firstTokenTime) / 1000;
                    const tokensPerSec = elapsed > 0 ? (tokenCount / elapsed).toFixed(2) : '0.00';
                    const timeToFirst = firstTokenTime ? ((firstTokenTime - startTime) / 1000).toFixed(2) : '0.00';
                    
                    statsSpan.innerHTML = `
                        <span>${tokensPerSec} tok/sec</span>
                        <span>${tokenCount} tokens</span>
                        <span>${timeToFirst}s to first token</span>
                    `;
                    
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                } else if (eventType === 'done') {
                    const avgSpeed = firstTokenTime ? ((tokenCount / ((Date.now() - firstTokenTime) / 1000))).toFixed(2) : '0.00';
                    const timeToFirst = firstTokenTime ? ((firstTokenTime - startTime) / 1000).toFixed(2) : '0.00';
                    
                    aiMsg.className = 'message assistant';
                    contentSpan.textContent = fullResponse;
                    statsSpan.innerHTML = `
                        <span>${avgSpeed} tok/sec</span>
                        <span>${tokenCount} tokens</span>
                        <span>${timeToFirst}s to first token</span>
                        <span>Stop reason: EOS Token Found</span>
                    `;

                    // Add assistant response to history
                    if (fullResponse) {
                        conversationHistory.push({
                            role: 'assistant',
                            content: fullResponse
                        });
                        console.log('Added to history. Total messages:', conversationHistory.length);
                    }
                } else if (eventType === 'error') {
                    throw new Error('Streaming error received from server');
                }
            }
        }

        // Process any remaining buffer
        if (buffer.trim()) {
            console.log('Remaining buffer:', buffer); // Debug log
            const lines = buffer.split('\n');
            let eventType = 'message';
            let data = '';

            for (const line of lines) {
                if (line.startsWith('event:')) {
                    eventType = line.slice(6).trim();
                } else if (line.startsWith('data:')) {
                    // Don't trim the data - preserve spaces!
                    const dataContent = line.slice(5);
                    data += dataContent.startsWith(' ') ? dataContent.slice(1) : dataContent;
                }
            }

            if (data) {
                fullResponse += data;
                contentSpan.textContent = fullResponse;
            }
        }

        // Ensure the response is added to history even if 'event: done' wasn't received
        if (fullResponse && !conversationHistory.some(msg => msg.role === 'assistant' && msg.content === fullResponse)) {
            conversationHistory.push({
                role: 'assistant',
                content: fullResponse
            });
            console.log('Added to history (fallback). Total messages:', conversationHistory.length);
            
            // Finalize the message display
            if (aiMsg.className === 'message streaming') {
                const avgSpeed = firstTokenTime ? ((tokenCount / ((Date.now() - firstTokenTime) / 1000))).toFixed(2) : '0.00';
                const timeToFirst = firstTokenTime ? ((firstTokenTime - startTime) / 1000).toFixed(2) : '0.00';
                
                aiMsg.className = 'message assistant';
                statsSpan.innerHTML = `
                    <span>${avgSpeed} tok/sec</span>
                    <span>${tokenCount} tokens</span>
                    <span>${timeToFirst}s to first token</span>
                    <span>Stream completed</span>
                `;
            }
        }

        console.log('Full response:', fullResponse);
        console.log('Complete conversation history:', conversationHistory);

    } catch (error) {
        console.error('Streaming error:', error);
        contentSpan.innerHTML = `<span style="color:#ff4444;">Erro no streaming: ${error.message}</span>`;
        throw error;
    }
}

document.getElementById('openUpload').onclick = () => {
    document.getElementById('uploadBox').style.display = 'block';
};

document.getElementById('cancelUpload').onclick = () => {
    document.getElementById('uploadBox').style.display = 'none';
    document.getElementById('uploadForm').reset();
};

document.getElementById('uploadForm').addEventListener('submit', async e => {
    e.preventDefault();
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    try {
        await fetch("/api/rag", { method:"POST", body:formData });
        
        const msg = document.createElement('div');
        msg.className = 'message assistant';
        msg.innerHTML = `<div>O arquivo "${escapeHtml(file.name)}" foi enviado!</div>`;
        messagesDiv.appendChild(msg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        document.getElementById('uploadBox').style.display = "none";
        e.target.reset();
    } catch (error) {
        alert('Erro ao enviar arquivo: ' + error.message);
    }
});

document.getElementById('helpBtn').onclick = () => {
    document.getElementById('helpBox').style.display = "block";
};

document.getElementById('closeHelp').onclick = () => {
    document.getElementById('helpBox').style.display = "none";
};

input.focus();
</script>
</body>
</html>
