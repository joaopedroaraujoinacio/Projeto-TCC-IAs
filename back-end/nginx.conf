events {
    worker_connections 1024;
}

http {
    upstream backend {
        server app:8080;        # ‚Üê YOUR service is called "app"
    }
    
    upstream ollama {
        server ollama:11434;    # ‚Üê Your ollama service
    }

    # HTTP to HTTPS redirect
    server {
        listen 80;
        return 301 https://$host$request_uri;
    }

    # HTTPS server
    server {
        listen 443 ssl;
        
        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        # Your Document Routes
        location /api/documents {
            proxy_pass http://backend;  # Goes to app:8080
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Your Code Document Routes  
        location /api/post_code {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/get_code {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/get_all_code {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Your RAG Chat Route
        location /api/chat {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
            
            # AI responses can be slow
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # Your Swagger Route
        location /api/hello {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Catch-all for /api/
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # Direct Ollama access
        location /ollama/ {
            proxy_pass http://ollama/;
            proxy_set_header Host $host;
            proxy_buffering off;
            proxy_read_timeout 300s;
        }
        
        # Root documentation
        location / {
            return 200 'RAG API Server - HTTPS Enabled ‚úÖ

üìö Document Management:
- POST /api/documents       - Create document
- GET  /api/documents       - Get all documents  
- GET  /api/documents/search - Search documents

üíª Code Management:  
- POST /api/post_code       - Create code document
- GET  /api/get_code        - Search code documents
- GET  /api/get_all_code    - Get all code documents

ü§ñ AI Chat:
- POST /api/chat            - Chat with RAG AI

üîß Utility:
- GET  /api/hello           - Swagger documentation

Access at: https://localhost
';
            add_header Content-Type text/plain;
        }
    }
}
